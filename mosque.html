<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosque Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
     <style>
       :root {
            --primary-color: #2575fc;
            --secondary-color: #6a11cb;
            --text-color: #333;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
        }
         .dark-mode {
            --primary-color: #4a90e2;
            --secondary-color: #7c4dff;
            --text-color: #ffffff;
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            scroll-behavior: smooth;
        }

 body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .mosque-finder-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        #mainMap {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .mosque-card {
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background-color: var(--card-bg);
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .mosque-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .mosque-card-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
   /* Header Container */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 50px;
    background: var(--bg-color);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: all 0.3s ease;
}

/* Logo Container */
.logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo {
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Header Buttons */
.header-buttons {
    display: flex;
    gap: 15px;
}

.btn {
    padding: 10px 20px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn i {
    font-size: 16px;
}

.btn-primary {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(37,117,252,0.2);
}

.btn-secondary {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--text-color);
}

.btn-secondary:hover {
    background: rgba(37,117,252,0.1);
}

/* Mobile Menu Toggle */
.mobile-menu-toggle {
    display: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-color);
    background: none;
    border: none;
    padding: 10px;
    transition: all 0.3s ease;
}

.mobile-menu-toggle:hover {
    transform: scale(1.1);
}

/* Sidebar Styles */
.sidebar {
    position: fixed;
    top: 0;
    right: -300px;
    width: 300px;
    height: 100vh;
    background: var(--card-bg);
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    padding: 20px;
    display: none;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(37,117,252,0.1);
}

.close-sidebar {
    font-size: 24px;
    color: var(--text-color);
    background: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.close-sidebar:hover {
    transform: rotate(90deg);
}

.sidebar .header-buttons {
    flex-direction: column;
    gap: 15px;
}

.sidebar .btn {
    width: 100%;
    justify-content: center;
}

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 999;
    backdrop-filter: blur(3px);
    transition: opacity 0.3s ease;
    opacity: 0;
}

.sidebar-overlay.active {
    opacity: 1;
}

/* Responsive Styles */
@media screen and (max-width: 1024px) {
    .header {
        padding: 15px 30px;
    }

    .logo {
        font-size: 20px;
    }

    .btn {
        padding: 8px 16px;
    }
}

@media screen and (max-width: 768px) {
    .header {
        padding: 15px 20px;
    }

    .header .header-buttons {
        display: none;
    }

    .mobile-menu-toggle {
        display: block;
    }

    .sidebar {
        display: block;
    }

    .sidebar.active {
        right: 0;
    }

    .sidebar-overlay.active {
        display: block;
    }

    .logo {
        font-size: 18px;
    }
}

@media screen and (max-width: 480px) {
    .header {
        padding: 12px 15px;
    }

    .sidebar {
        width: 280px;
    }

    .btn {
        padding: 8px 14px;
        font-size: 14px;
    }

    .mobile-menu-toggle {
        font-size: 20px;
    }
}

/* Dark Mode Adjustments */
.dark-mode .sidebar {
    background: var(--bg-color);
}

.dark-mode .sidebar-header {
    border-bottom-color: rgba(255,255,255,0.1);
}

/* Animation Classes */
@keyframes slideIn {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.sidebar.active {
    animation: slideIn 0.3s ease forwards;
}

.sidebar-overlay.active {
    animation: fadeIn 0.3s ease forwards;
}


        .ai-insights {
            background-color: #e6f3ff;
            border-left: 4px solid var(--primary-color);
            padding: 10px;
            margin-top: 10px;
        }

        .search-section {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-success {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            #mainMap {
                height: 300px;
            }

            .mosque-finder-container {
                padding: 10px;
            }
        }

        /* Loading Placeholder */
        .loading-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
        }
        
        .filter-section {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .mosque-card .distance-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 8px;
        }
         .mosque-card {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .star-rating {
        color: #ffd700;
        font-size: 1.2em;
    }

    .popularity-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .high-traffic {
        background-color: #ff6b6b;
        color: white;
    }

    .moderate-traffic {
        background-color: #ffd93d;
        color: black;
    }

    .low-traffic {
        background-color: #6dd5af;
        color: white;
    }

    .lazy-image {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .lazy-image.loaded {
        opacity: 1;
    }

    .mosque-stats {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        font-size: 0.9em;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .unknown-rating {
        color: #999;
        font-style: italic;
    }
        /* Shapes */
        .shape {
            position: absolute;
            z-index: -1;
        }

        .shape-1 {
            top: 20%;
            left: 10%;
            width: 300px;
            height: 300px;
            background: linear-gradient(45deg, rgba(37,117,252,0.1), rgba(106,17,203,0.1));
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            animation: morphing 15s infinite;
        }

        .shape-2 {
            bottom: 20%;
            right: 10%;
            width: 200px;
            height: 200px;
            background: linear-gradient(45deg, rgba(106,17,203,0.1), rgba(37,117,252,0.1));
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation: morphing 12s infinite reverse;
        }

        @keyframes morphing {
            0% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
            25% { border-radius: 58% 42% 75% 25% / 76% 46% 54% 24%; }
            50% { border-radius: 50% 50% 33% 67% / 55% 27% 73% 45%; }
            75% { border-radius: 33% 67% 58% 42% / 63% 68% 32% 37%; }
            100% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
        }
     /* Modern Scroll Bar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
        }
        .footer {
    background: var(--bg-color);
    padding: 50px 20px;
    margin-top: 50px;
}

.footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 40px;
}

.footer-section {
    padding: 20px;
}

.newsletter-form {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.newsletter-input {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid var(--primary-color);
    border-radius: 25px;
    background: transparent;
    color: var(--text-color);
}

/* Responsive Design */
@media (max-width: 768px) {
    .footer {
        padding: 40px 15px;
    }

    .footer-content {
        grid-template-columns: 1fr; /* Stacks sections vertically on smaller screens */
        gap: 30px;
    }

    .newsletter-form {
        flex-direction: column;
    }

    .newsletter-input {
        width: 100%; /* Full width on smaller screens */
    }
}

@media (max-width: 480px) {
    .footer {
        padding: 30px 10px;
    }

    .footer-content {
        gap: 20px;
    }

    .newsletter-form {
        gap: 15px;
    }

    .newsletter-input {
        padding: 8px 12px;
    }
}
.share-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1001;
}

.share-modal {
    background: var(--card-bg);
    padding: 30px;
    border-radius: 20px;
    max-width: 400px;
    width: 90%;
    position: relative;
}

.share-close {
    position: absolute;
    top: 15px;
    right: 15px;
    cursor: pointer;
    font-size: 24px;
    color: var(--text-color);
}

.share-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.share-option {
    text-align: center;
    cursor: pointer;
    padding: 10px;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.share-option:hover {
    background: rgba(37,117,252,0.1);
}

.copy-url {
    display: flex;
    margin-top: 20px;
    gap: 10px;
}

.url-input {
    flex: 1;
    padding: 10px;
    border: 2px solid var(--primary-color);
    border-radius: 25px;
    background: transparent;
    color: var(--text-color);
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .share-options {
        grid-template-columns: repeat(2, 1fr); /* Adjust to two columns on smaller screens */
    }

    .share-modal {
        padding: 20px;
        max-width: 90%; /* Ensure modal takes more width on smaller screens */
    }

    .share-close {
        font-size: 20px; /* Smaller close button for smaller screens */
        top: 10px;
        right: 10px;
    }

    .copy-url {
        flex-direction: column;
        align-items: stretch; /* Stack input and button vertically */
    }

    .url-input {
        margin-bottom: 10px; /* Add space between input and button */
    }
}

@media (max-width: 480px) {
    .share-options {
        grid-template-columns: 1fr; /* Stack options in a single column */
    }

    .share-modal {
        padding: 15px;
        width: 80%; /* Make the modal more compact on very small screens */
    }

    .share-close {
        font-size: 18px; /* Further reduce size of the close button */
    }

    .url-input {
        padding: 8px; /* Adjust input padding for smaller screens */
    }
}
    .swal2-styled.swal2-confirm {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)) !important;
    border: none !important;
}
         .quick-links a {
            color: var(--text-color);
            text-decoration: none;
            position: relative;
            display: block;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .quick-links a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -2px;
            left: 0;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .quick-links a:hover::after {
            width: 100%;
        }
        .prayer-times-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.prayer-time {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.prayer-time h6 {
    margin: 0;
    color: var(--primary-color);
}

.ai-analysis {
    background: linear-gradient(45deg, rgba(37,117,252,0.1), rgba(106,17,203,0.1));
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}

.analysis-content {
    font-size: 0.95em;
    line-height: 1.6;
}

.mosque-images {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

.mosque-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.mosque-image:hover {
    transform: scale(1.05);
}

    </style>
</head>
<body>
    <!-- Auth Buttons -->
    <div class="auth-buttons">
        <button class="btn btn-light animate__animated animate__fadeIn" data-bs-toggle="modal" data-bs-target="#signInModal">
            Sign In
        </button>
    </div>

    <!-- Theme Switch -->
    <div class="theme-switch">
        <button class="btn btn-light" id="themeToggle">
            🌙
        </button>
    </div>

    <!-- Header -->
    <header class="header text-center py-5">
        <h1 class="animate__animated animate__fadeInDown">
            Mosque Finder
        </h1>
        <p class="animate__animated animate__fadeIn animate__delay-1s">
            Discover nearby mosques and prayer spaces
        </p>
    </header>

    <!-- Search Container -->
    <div class="search-container animate__animated animate__fadeInUp">
        <div class="input-group mb-3">
            <input type="text" id="cityInput" class="form-control" placeholder="Enter city name...">
            <button class="btn btn-primary" id="searchButton">
                Search
            </button>
            <button class="btn btn-secondary" id="locateButton">
                📍
            </button>
        </div>
    </div>

    <!-- Map -->
    <div class="container">
        <div id="mainMap" class="animate__animated animate__fadeIn"></div>
        
        <!-- Results -->
        <div class="row" id="mosqueList"></div>
        
        <!-- Load More -->
        <div class="text-center mb-4">
            <button id="loadMoreButton" class="btn btn-primary" style="display: none;">
                Load More
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <!-- Sign In Modal -->
    <div class="modal fade" id="signInModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sign In</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Sign In</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <!-- Theme Toggle Script -->
    <script>
        document.getElementById('themeToggle').addEventListener('click', function() {
            const body = document.body;
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                this.textContent = '🌙';
            } else {
                body.setAttribute('data-theme', 'dark');
                this.textContent = '☀️';
            }
        });
    class MosqueFinder {
    constructor() {
        this.map = null;
        this.markers = [];
        this.mosques = [];
        this.userLocation = null;
        this.geminiApiKey = 'AIzaSyBBhXs0Wd66ceLEHW6qsUjja78BSMAD9G4';
        this.currentPage = 1;
        this.mosquesPerPage = 5;
        this.initializeMap();
        this.setupEventListeners();
    }

    initializeMap() {
        this.map = L.map('mainMap').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(this.map);
    }

    setupEventListeners() {
        document.getElementById('searchButton')?.addEventListener('click', () => this.searchMosques());
        document.getElementById('locateButton')?.addEventListener('click', () => this.getUserLocation());
        document.getElementById('cityInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.searchMosques();
        });
        document.getElementById('loadMoreButton')?.addEventListener('click', () => this.loadMoreMosques());

        window.addEventListener('resize', () => {
            if (this.map) {
                this.map.invalidateSize();
            }
        });
    }

    async searchMosques() {
        const city = document.getElementById('cityInput')?.value.trim();
        if (!city) {
            this.showAlert('Please enter a city name', 'warning');
            return;
        }

        this.showLoadingState(true);
        this.currentPage = 1;
        this.clearResults();
        
        try {
            const locationData = await this.getCityCoordinates(city);
            if (!locationData) {
                throw new Error('Location not found');
            }

            this.map.setView([locationData.lat, locationData.lon], 12);
            const mosques = await this.fetchMosques(locationData.lat, locationData.lon);
            await this.processMosqueData(mosques, city);
        } catch (error) {
            this.showAlert(error.message || 'Error searching for mosques', 'error');
            this.clearResults();
        } finally {
            this.showLoadingState(false);
        }
    }

    showLoadingState(isLoading) {
        const searchButton = document.getElementById('searchButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        if (searchButton) {
            searchButton.disabled = isLoading;
            searchButton.innerHTML = isLoading ? 
                '<span class="spinner-border spinner-border-sm"></span> Searching...' : 
                'Search';
        }

        if (loadingOverlay) {
            loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        }
    }

    async getCityCoordinates(city) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1`);
            const data = await response.json();

            if (data.length === 0) return null;
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon)
            };
        } catch (error) {
            throw new Error('Failed to get city coordinates');
        }
    }

    async fetchMosques(lat, lon) {
        const query = `
            [out:json][timeout:25];
            (
                node["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${lat},${lon});
                way["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${lat},${lon});
                relation["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${lat},${lon});
            );
            out body;
            >;
            out skel qt;
        `;

        try {
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            });
            const data = await response.json();
            return data.elements;
        } catch (error) {
            throw new Error('Failed to fetch mosque data');
        }
    }

    async processMosqueData(mosques, city) {
        this.clearMap();
        this.mosques = mosques
            .filter(m => m.type === 'node' && m.tags?.name)
            .map(m => ({
                id: m.id,
                name: m.tags.name,
                lat: m.lat,
                lon: m.lon,
                city: city,
                denomination: m.tags.denomination || 'Not specified',
                address: this.formatAddress(m.tags),
                isAnalyzed: false
            }));

        await this.displayMosquePage(1);
        this.updateLoadMoreButton();
    }

    formatAddress(tags) {
        const addressParts = [];
        if (tags['addr:street']) addressParts.push(tags['addr:street']);
        if (tags['addr:housenumber']) addressParts.push(tags['addr:housenumber']);
        if (tags['addr:postcode']) addressParts.push(tags['addr:postcode']);
        return addressParts.length > 0 ? addressParts.join(', ') : 'Address not available';
    }

    async displayMosquePage(page) {
        const startIdx = (page - 1) * this.mosquesPerPage;
        const endIdx = startIdx + this.mosquesPerPage;
        const pageMosques = this.mosques.slice(startIdx, endIdx);

        for (const mosque of pageMosques) {
            if (!mosque.isAnalyzed) {
                this.showMosqueLoadingState(mosque.id);
                await this.fetchMosqueDetails(mosque);
                mosque.isAnalyzed = true;
            }
        }

        this.updateMap(this.mosques);
        this.renderMosqueList();
    }

    async loadMoreMosques() {
        this.currentPage++;
        await this.displayMosquePage(this.currentPage);
        this.updateLoadMoreButton();
    }

    updateLoadMoreButton() {
        const loadMoreButton = document.getElementById('loadMoreButton');
        if (loadMoreButton) {
            const remainingMosques = this.mosques.length - (this.currentPage * this.mosquesPerPage);
            loadMoreButton.style.display = remainingMosques > 0 ? 'block' : 'none';
        }
    }

    showMosqueLoadingState(mosqueId) {
        const mosqueCard = document.querySelector(`#mosque-${mosqueId}`);
        if (mosqueCard) {
            mosqueCard.querySelector('.mosque-details').innerHTML = `
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Analyzing mosque details...</span>
                    </div>
                    <p class="mt-2">Analyzing mosque details...</p>
                </div>
            `;
        }
    }

    async fetchMosqueDetails(mosque) {
        try {
            const response = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.geminiApiKey}`
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `Analyze the mosque "${mosque.name}" in ${mosque.city}. 
                            Provide verified information about:
                            1. Historical significance
                            2. Architectural style
                            3. Prayer facilities
                            4. Community services
                            5. Notable features
                            If information is not available or uncertain, exclude those fields.
                            Format as JSON with only verified information.`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.3,
                        topK: 20,
                        topP: 0.8,
                        maxOutputTokens: 1024,
                    }
                })
            });

            if (!response.ok) throw new Error('Failed to fetch mosque details');

            const data = await response.json();
            try {
                const detailsText = data.candidates[0].content.parts[0].text;
                const details = JSON.parse(detailsText);
                
                const cleanDetails = {};
                for (const [key, value] of Object.entries(details)) {
                    if (value && 
                        value !== 'Information not available' && 
                        value !== 'Unknown' && 
                        value !== 'Not specified' &&
                        value.length > 0) {
                        cleanDetails[key] = value;
                    }
                }
                
                Object.assign(mosque, cleanDetails);
            } catch (parseError) {
                console.error('Error parsing Gemini response:', parseError);
            }
        } catch (error) {
            console.error('Error fetching mosque details:', error);
        }
    }

    updateMap(mosques) {
        this.clearMap();
        mosques.forEach(mosque => {
            const marker = L.marker([mosque.lat, mosque.lon])
                .addTo(this.map)
                .bindPopup(this.createPopupContent(mosque));
            this.markers.push(marker);
        });
    }

    createPopupContent(mosque) {
        const details = [];
        if (mosque.historicalSignificance) details.push(`<p><strong>Historical Significance:</strong><br>${mosque.historicalSignificance}</p>`);
        if (mosque.architecture) details.push(`<p><strong>Architecture:</strong><br>${mosque.architecture}</p>`);
        if (mosque.prayerFacilities) details.push(`<p><strong>Prayer Facilities:</strong><br>${mosque.prayerFacilities}</p>`);
        if (mosque.communityServices) details.push(`<p><strong>Community Services:</strong><br>${mosque.communityServices}</p>`);
        if (mosque.notableFeatures) details.push(`<p><strong>Notable Features:</strong><br>${mosque.notableFeatures}</p>`);

        return `
            <div class="popup-content">
                <h5>${mosque.name}</h5>
                ${mosque.denomination !== 'Not specified' ? `<p><strong>Denomination:</strong> ${mosque.denomination}</p>` : ''}
                ${mosque.address !== 'Address not available' ? `<p><strong>Address:</strong> ${mosque.address}</p>` : ''}
                <div class="mosque-details">
                    ${details.length > 0 ? details.join('') : '<p class="text-muted">No detailed information available</p>'}
                </div>
                <div class="popup-actions">
                    <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${mosque.lat},${mosque.lon}', '_blank')" class="btn btn-sm btn-primary">
                        Get Directions
                    </button>
                </div>
            </div>
        `;
    }

    renderMosqueList() {
        const list = document.getElementById('mosqueList');
        if (!list) return;

        if (this.mosques.length === 0) {
            list.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">No mosques found in this area</div>
                </div>
            `;
            return;
        }

        const startIdx = 0;
        const endIdx = this.currentPage * this.mosquesPerPage;
        const displayedMosques = this.mosques.slice(startIdx, endIdx);

        list.innerHTML = displayedMosques.map(mosque => this.createMosqueCard(mosque)).join('');
    }

    createMosqueCard(mosque) {
        const details = [];
        
        if (mosque.historicalSignificance) details.push(`<p><strong>Historical Significance:</strong><br>${mosque.historicalSignificance}</p>`);
        if (mosque.architecture) details.push(`<p><strong>Architecture:</strong><br>${mosque.architecture}</p>`);
        if (mosque.prayerFacilities) details.push(`<p><strong>Prayer Facilities:</strong><br>${mosque.prayerFacilities}</p>`);
        if (mosque.communityServices) details.push(`<p><strong>Community Services:</strong><br>${mosque.communityServices}</p>`);
        if (mosque.notableFeatures) details.push(`<p><strong>Notable Features:</strong><br>${mosque.notableFeatures}</p>`);

        return `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 mosque-card" id="mosque-${mosque.id}">
                    <div class="card-body">
                        <h5 class="card-title">${mosque.name}</h5>
                        <p class="card-text">
                            ${mosque.denomination !== 'Not specified' ? `<strong>Denomination:</strong> ${mosque.denomination}<br>` : ''}
                            ${mosque.address !== 'Address not available' ? `<strong>Address:</strong> ${mosque.address}` : ''}
                        </p>
                        <div class="mosque-details">
                            ${details.length > 0 ? details.join('') : '<p class="text-muted">No detailed information available</p>'}
                        </div>
                        <div class="card-actions mt-3">
                            <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${mosque.lat},${mosque.lon}', '_blank')" 
                                    class="btn btn-primary btn-sm">
                                Get Directions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    getUserLocation() {
        if (!navigator.geolocation) {
            this.showAlert('Geolocation is not supported by your browser', 'warning');
            return;
        }

        this.showAlert('Fetching your location...', 'info');

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    const { latitude, longitude } = position.coords;
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                    const data = await response.json();

                    const city = data.address.city || 
                               data.address.town || 
                               data.address.village || 
                               'Current Location';

                    const cityInput = document.getElementById('cityInput');
                    if (cityInput) {
                        cityInput.value = city;
                    }
                    
                    this.userLocation = { lat: latitude, lon: longitude };
                    this.searchMosques();
                } catch (error) {
                    this.showAlert('Error getting location details', 'error');
                }
            },
            (error) => {
                this.showAlert(this.getGeolocationErrorMessage(error), 'error');
            }
        );
    }

   getGeolocationErrorMessage(error) {
        const messages = {
            1: 'Permission denied. Please enable location services.',
            2: 'Location information unavailable.',
            3: 'Location request timed out.'
        };
        return messages[error.code] || 'An unknown error occurred.';
    }

    showAlert(message, type = 'info') {
        if (typeof Swal === 'undefined') {
            alert(message);
            return;
        }

        Swal.fire({
            text: message,
            icon: type,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
    }

    clearMap() {
        this.markers.forEach(marker => this.map.removeLayer(marker));
        this.markers = [];
    }

    clearResults() {
        const mosqueList = document.getElementById('mosqueList');
        if (mosqueList) {
            mosqueList.innerHTML = '';
        }
        this.clearMap();
        
        // Reset pagination
        this.currentPage = 1;
        const loadMoreButton = document.getElementById('loadMoreButton');
        if (loadMoreButton) {
            loadMoreButton.style.display = 'none';
        }
    }

    // Sort mosques by rating or relevance
    sortMosques() {
        // Sort mosques based on available information and potential significance
        this.mosques.sort((a, b) => {
            const aScore = this.calculateMosqueScore(a);
            const bScore = this.calculateMosqueScore(b);
            return bScore - aScore;
        });
    }

    // Calculate a score for mosque sorting
    calculateMosqueScore(mosque) {
        let score = 0;
        
        // Add points for available information
        if (mosque.historicalSignificance) score += 2;
        if (mosque.architecture) score += 1;
        if (mosque.prayerFacilities) score += 1;
        if (mosque.communityServices) score += 1;
        if (mosque.notableFeatures) score += 1;
        if (mosque.denomination !== 'Not specified') score += 1;
        if (mosque.address !== 'Address not available') score += 1;

        // Bonus points for length of description (indicating more detailed information)
        const detailsLength = [
            mosque.historicalSignificance || '',
            mosque.architecture || '',
            mosque.prayerFacilities || '',
            mosque.communityServices || '',
            mosque.notableFeatures || ''
        ].join('').length;

        score += Math.min(detailsLength / 100, 5); // Cap the bonus at 5 points

        return score;
    }
}

// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    window.mosqueFinder = new MosqueFinder();
});
    </script>
</body>
</html>
